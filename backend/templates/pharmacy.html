{% extends "base.html" %} {% block head_extra %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/pharmacy.css') }}"
/>
<!-- Select2 CSS (for searchable dropdown like inventory) -->
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
{% endblock %} {% block title %}Pharmacy - IMS{% endblock %} {% block content %}
<div class="container">
  <header class="main-header">
    <h2 class="page-title">Pharmacy</h2>
  </header>

  <div class="content">
    <!-- Patient Details Section -->
    <div class="patient-section">
      <legend>Patient Details</legend>

      <form
        method="POST"
        action="{{ url_for('pharmacy.pharmacy') }}"
        class="pharmacy-form"
      >
        <div class="form-row">
          <div class="field">
            <label for="patient_name">Patient Name *</label>
            <select
              id="patient_name"
              name="patient_name"
              class="patient-select"
              required
            >
              <option value="">Select or type patient name</option>
              {% for patient in today_patients %}
              <option
                value="{{ patient.PName }}"
                data-phone="{{ patient.Phone }}"
                data-uhid="{{ patient.UHId }}"
              >
                {{ patient.PName }} - {{ patient.UHId }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="field">
            <label for="phone_no">Phone Number</label>
            <input
              type="tel"
              id="phone_no"
              name="phone_no"
              placeholder="Enter 10-digit phone number"
              pattern="[0-9]{10}"
              maxlength="10"
            />
          </div>

          <div class="field">
            <label for="uhid">UHId</label>
            <input
              type="text"
              id="uhid"
              name="uhid"
              placeholder="Auto-generated for new patients"
              readonly
            />
          </div>
        </div>

        <!-- Additional Patient Details (shown for new patients) -->
        <div
          class="form-row"
          id="additional_patient_fields"
          style="display: none"
        >
          <div class="field">
            <label for="age">Age</label>
            <input
              type="number"
              id="age"
              name="age"
              placeholder="Age"
              min="0"
              max="150"
            />
          </div>

          <div class="field">
            <label for="gender">Gender</label>
            <select id="gender" name="gender">
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="field">
            <!-- Empty field for alignment -->
          </div>
        </div>

        <!-- Medicines Section -->
        <legend>Medicines</legend>

        <!-- Debudding messages cause not able to load the medicines in the blueprint route -->
        {% if medicines %}
        <p style="color: green; font-size: 12px; margin: 5px 0">
          âœ“ Loaded {{ medicines|length }} medicines
        </p>
        {% else %}
        <p style="color: red; font-size: 12px; margin: 5px 0">
          âœ— No medicines loaded!
        </p>
        {% endif %}

        <div class="medicines-section">
          <div class="add-medicine-row">
            <div class="field">
              <label for="medicine_name">Medicine Name</label>
              <select
                id="medicine_name"
                name="medicine_name"
                class="medicine-select"
              >
                <option value="">Select Medicine</option>
                {% for medicine in medicines %}
                <option
                  value="{{ medicine.MName }}"
                  data-price="{{ medicine.MRP }}"
                  data-mid="{{ medicine.MId }}"
                  data-company="{{ medicine.MCompany }}"
                  data-stock="{{ medicine.CurrentStock }}"
                  data-type="{{ medicine.MType }}"
                >
                  {{ medicine.MName }} - â‚¹{{ medicine.MRP }} (Stock: {{
                  medicine.CurrentStock }})
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="batch_no">Batch No</label>
              <input
                type="text"
                id="batch_no"
                name="batch_no"
                value="-"
                placeholder="-"
                readonly
              />
            </div>

            <div class="field">
              <label for="quantity">Quantity</label>
              <input
                type="number"
                id="quantity"
                name="quantity"
                min="1"
                placeholder="Qty"
              />
            </div>

            <div class="field">
              <label for="duration">Duration</label>
              <input
                type="text"
                id="duration"
                name="duration"
                placeholder="e.g., 7 days"
              />
            </div>

            <div class="field">
              <button type="button" id="add_medicine_btn" class="btn-add">
                Add Medicine
              </button>
            </div>
          </div>

          <!-- Medicine Details Display Section (separate block below selection) -->
          <div
            class="medicine-details-section"
            id="medicine_details_section"
            style="display: none"
          >
            <div class="details-card">
              <h4 class="details-title">Medicine Details</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <span class="detail-label">MRP:</span>
                  <span class="detail-value" id="detail_mrp">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value" id="detail_type">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Batch No:</span>
                  <span class="detail-value" id="detail_batch">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Medicines Table -->
        <div class="medicines-table-section">
          <table class="medicines-table" id="medicines_table">
            <thead>
              <tr>
                <th>Medicine</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Duration</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="medicines_tbody">
              <!-- Medicines will be added here -->
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4"><strong>Total Amount:</strong></td>
                <td id="grand_total"><strong>â‚¹0.00</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Payment Section -->
        <div class="payment-section">
          <legend>Payment</legend>

          <div class="form-row">
            <div class="field">
              <label for="discount_amount">Discount</label>
              <input
                type="number"
                step="0.01"
                id="discount_amount"
                name="discount_amount"
                placeholder="0.00 (use negative to add)"
                oninput="updatePaymentTotal(grandTotal)"
                onchange="updatePaymentTotal(grandTotal)"
              />
            </div>

            <div class="field">
              <label for="payment_mode">Payment Mode</label>
              <select id="payment_mode" name="payment_mode">
                <option value="">Select payment mode</option>
                <option value="Cash">Cash</option>
                <option value="UPI">UPI</option>
                <option value="Both">Both</option>
              </select>
            </div>

            <div class="field" id="cash_amount_field" style="display: none">
              <label for="cash_amount">Cash Amount</label>
              <input
                type="number"
                step="0.01"
                min="0"
                id="cash_amount"
                name="cash_amount"
                placeholder="0.00"
              />
            </div>

            <div class="field" id="upi_amount_field" style="display: none">
              <label for="upi_amount">UPI Amount</label>
              <input
                type="number"
                step="0.01"
                min="0"
                id="upi_amount"
                name="upi_amount"
                placeholder="0.00"
              />
            </div>

            <div class="field">
              <label>Total to Pay</label>
              <input
                type="text"
                id="pay_total_readonly"
                value="â‚¹0.00"
                readonly
              />
            </div>
          </div>

          <div class="form-row">
            <div class="field" style="flex: 1">
              <label for="payment_comments">Comments</label>
              <input
                type="text"
                id="payment_comments"
                name="payment_comments"
                placeholder="Reason for discount or payment notes"
              />
            </div>
          </div>
        </div>

        <!-- Submit Section -->
        <div class="actions">
          <button type="submit" class="btn-submit">Submit Prescription</button>
          <button type="reset" class="btn-reset">Clear Form</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // jQuery & Select2 (used in inventory) for searchable dropdown
  (function () {
    const scriptJq = document.createElement("script");
    scriptJq.src = "https://code.jquery.com/jquery-3.6.0.min.js";
    scriptJq.onload = function () {
      const scriptS2 = document.createElement("script");
      scriptS2.src =
        "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js";
      scriptS2.onload = function () {
        if (window.$ && $.fn && $.fn.select2) {
          try {
            // Initialize Medicine Select2
            $(".medicine-select").select2({
              placeholder: "Select Medicine",
              allowClear: true,
              width: "resolve",
            });

            // Initialize Patient Select2 with tagging (allow new entries)
            $(".patient-select").select2({
              placeholder: "Select or type patient name",
              allowClear: true,
              width: "resolve",
              tags: true,
              createTag: function (params) {
                var term = $.trim(params.term);
                if (term === "") {
                  return null;
                }
                // Create a tag for new patient
                return {
                  id: term,
                  text: term + " (New Patient - Click to Add)",
                  newTag: true,
                };
              },
            });

            console.log(
              "âœ“ Select2 initialized for patient and medicine dropdowns"
            );
          } catch (e) {
            console.warn("Select2 init failed:", e);
          }
        }
      };
      document.body.appendChild(scriptS2);
    };
    document.body.appendChild(scriptJq);
  })();

  // Auto-fill patient details when selected from dropdown and handle new patients
  // Wait for Select2 to be initialized
  setTimeout(function () {
    if (window.$ && $.fn && $.fn.select2) {
      $("#patient_name").on("select2:select", function (e) {
        const selectedData = e.params.data;
        const patientName = selectedData.id;
        const isNewPatient = selectedData.newTag === true;

        const phoneInput = document.getElementById("phone_no");
        const uhidInput = document.getElementById("uhid");
        const additionalFields = document.getElementById(
          "additional_patient_fields"
        );

        if (isNewPatient) {
          // New patient selected - show additional fields
          console.log("ðŸ†• New patient will be added:", patientName);

          phoneInput.value = "";
          uhidInput.value = "";
          uhidInput.placeholder = "Generating UHIdâ€¦";
          additionalFields.style.display = "flex";

          // Fetch next UHId preview for this name and show it
          const nextUhidUrl = `{{ url_for('pharmacy.pharmacy') }}api/next-uhid?name=${encodeURIComponent(
            patientName
          )}`;
          fetch(nextUhidUrl)
            .then((r) => r.json())
            .then((payload) => {
              if (payload && payload.success && payload.uhid) {
                uhidInput.value = payload.uhid;
                uhidInput.placeholder = "Patient UHId";
                console.log("âœ“ Next UHId:", payload.uhid);
              } else {
                uhidInput.placeholder = "UHId unavailable";
              }
            })
            .catch((err) => {
              console.warn("UHId fetch failed:", err);
              uhidInput.placeholder = "UHId unavailable";
            });
        } else {
          // Existing patient - auto-fill details
          const selectElement = document.getElementById("patient_name");
          const selectedOption =
            selectElement.options[selectElement.selectedIndex];

          if (selectedOption && selectedOption.dataset.phone) {
            phoneInput.value = selectedOption.dataset.phone || "";
            uhidInput.value = selectedOption.dataset.uhid || "";
            uhidInput.placeholder = "Patient UHId";
            additionalFields.style.display = "none";

            // Remove new patient indicator if exists
            const indicator = document.querySelector(".new-patient-indicator");
            if (indicator) indicator.remove();

            console.log(
              "âœ“ Existing patient selected:",
              patientName,
              "UHId:",
              selectedOption.dataset.uhid
            );
          }
        }
      });

      // Handle clearing selection
      $("#patient_name").on("select2:clear", function () {
        document.getElementById("phone_no").value = "";
        document.getElementById("uhid").value = "";
        document.getElementById("uhid").placeholder = "Patient UHId";
        document.getElementById("additional_patient_fields").style.display =
          "none";

        const indicator = document.querySelector(".new-patient-indicator");
        if (indicator) indicator.remove();

        console.log("â„¹ Patient selection cleared");
      });
    }
  }, 1000); // Wait 1 second for Select2 to initialize

  // Validate phone number format
  document.getElementById("phone_no").addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, ""); // Remove non-digits
    if (this.value.length > 10) {
      this.value = this.value.slice(0, 10);
    }
  });

  // Handle medicine selection and fetch details
  function handleMedicineSelection() {
    const medicineSelect = document.getElementById("medicine_name");
    const medicineName = medicineSelect.value;

    const detailsSection = document.getElementById("medicine_details_section");
    const batchNoInput = document.getElementById("batch_no");

    if (!medicineName) {
      // Hide details section if no medicine selected
      detailsSection.style.display = "none";
      batchNoInput.value = "";
      return;
    }

    // Show loading state
    detailsSection.style.display = "block";
    document.getElementById("detail_mrp").textContent = "Loading...";
    document.getElementById("detail_type").textContent = "Loading...";
    document.getElementById("detail_batch").textContent = "Loading...";

    // Fetch medicine details from backend using pharmacy base URL
    const detailsUrl = `{{ url_for('pharmacy.pharmacy') }}api/medicine-details?name=${encodeURIComponent(
      medicineName
    )}`;
    console.log("[Pharmacy UI] ðŸ” Fetching:", detailsUrl);

    fetch(detailsUrl)
      .then((response) => {
        console.log("[Pharmacy UI] ðŸ“¡ Response status:", response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        // Read as text first to see raw response
        return response.text();
      })
      .then((text) => {
        console.log("[Pharmacy UI] ðŸ“„ Raw response text:", text);
        // Parse JSON
        const payload = JSON.parse(text);
        console.log("[Pharmacy UI] ðŸ“¦ Parsed JSON:", payload);
        console.log(
          "[Pharmacy UI] âœ“ success:",
          payload.success,
          "| data:",
          payload.data
        );

        if (payload && payload.success && payload.data) {
          const medicine = payload.data;
          console.log("[Pharmacy UI] ðŸ’Š Medicine data:", medicine);

          // Update detail labels - MRP, Type, BatchNo only
          document.getElementById("detail_mrp").textContent =
            medicine.MRP != null && medicine.MRP !== ""
              ? `â‚¹${parseFloat(medicine.MRP).toFixed(2)}`
              : "-";
          document.getElementById("detail_type").textContent =
            medicine.MType || "-";
          document.getElementById("detail_batch").textContent =
            medicine.BatchNo || "-";

          // Auto-fill batch number in the input field
          batchNoInput.value = medicine.BatchNo || "-";
          console.log("[Pharmacy UI] âœ… Details updated successfully");
        } else {
          // Show error state
          console.error("[Pharmacy UI] âŒ Invalid payload structure:", payload);
          document.getElementById("detail_mrp").textContent = "Error";
          document.getElementById("detail_type").textContent = "Error";
          document.getElementById("detail_batch").textContent = "Error";
        }
      })
      .catch((error) => {
        console.error("[Pharmacy UI] âŒ Fetch error:", error);
        document.getElementById("detail_mrp").textContent = "Error";
        document.getElementById("detail_type").textContent = "Error";
        document.getElementById("detail_batch").textContent = "Error";
      });
  }

  // Attach event listener to medicine select (works with both regular select and select2)
  document
    .getElementById("medicine_name")
    .addEventListener("change", handleMedicineSelection);

  // Also handle select2 change event (after select2 is initialized)
  setTimeout(() => {
    if (window.$ && $.fn && $.fn.select2) {
      $("#medicine_name").on("select2:select", handleMedicineSelection);
      $("#medicine_name").on("select2:clear", function () {
        document.getElementById("medicine_details_section").style.display =
          "none";
        document.getElementById("batch_no").value = "-";
      });
    }
  }, 1000); // Match the patient select2 initialization delay

  // Medicine management
  let medicineCount = 0;
  let grandTotal = 0;

  function getDiscountValue() {
    const input = document.getElementById("discount_amount");
    if (!input) return 0;
    const inputValue = input.value.trim();
    if (!inputValue) return 0;
    const val = parseFloat(inputValue);
    if (isNaN(val)) return 0;
    // Allow negative values (they will add to total)
    return val;
  }

  document
    .getElementById("add_medicine_btn")
    .addEventListener("click", function () {
      const medicineName = document.getElementById("medicine_name");
      const quantity = document.getElementById("quantity");
      const dosage = { value: "" };
      const duration = document.getElementById("duration");

      if (!medicineName.value || !quantity.value) {
        alert("Please select medicine and enter quantity");
        return;
      }

      const selectedOption = medicineName.options[medicineName.selectedIndex];
      const price = parseFloat(selectedOption.dataset.price) || 0;
      const stock = parseInt(selectedOption.dataset.stock) || 0;
      const requestedQty = parseInt(quantity.value);

      // Validate stock availability
      if (requestedQty > stock) {
        alert(
          `Insufficient stock! Available: ${stock}, Requested: ${requestedQty}`
        );
        return;
      }

      const total = price * requestedQty;

      // Add to table
      const tbody = document.getElementById("medicines_tbody");
      const row = tbody.insertRow();
      medicineCount++;

      row.innerHTML = `
        <td>${medicineName.value}</td>
        <td>${quantity.value}</td>
        <td>â‚¹${price.toFixed(2)}</td>
        
        <td>${duration.value || "-"}</td>
        <td>â‚¹${total.toFixed(2)}</td>
        <td><button type="button" class="btn-remove" onclick="removeMedicine(this, ${total})">Remove</button></td>
        <input type="hidden" name="medicine_${medicineCount}" value="${
        medicineName.value
      }">
        <input type="hidden" name="quantity_${medicineCount}" value="${
        quantity.value
      }">
        <input type="hidden" name="price_${medicineCount}" value="${price}">
        
        <input type="hidden" name="duration_${medicineCount}" value="${
        duration.value || ""
      }">
        <input type="hidden" name="total_${medicineCount}" value="${total}">
    `;

      // Update grand total
      grandTotal += total;
      document.getElementById(
        "grand_total"
      ).innerHTML = `<strong>â‚¹${grandTotal.toFixed(2)}</strong>`;

      // Reflect total in payment section
      updatePaymentTotal(grandTotal);

      // Clear inputs and hide medicine details section
      medicineName.selectedIndex = 0;
      quantity.value = "";

      duration.value = "";
      document.getElementById("batch_no").value = "";
      document.getElementById("medicine_details_section").style.display =
        "none";

      // Trigger select2 clear if available
      if (window.$ && $.fn && $.fn.select2) {
        $("#medicine_name").val(null).trigger("change");
      }
    });

  function removeMedicine(button, amount) {
    button.closest("tr").remove();
    grandTotal -= amount;
    document.getElementById(
      "grand_total"
    ).innerHTML = `<strong>â‚¹${grandTotal.toFixed(2)}</strong>`;

    // Reflect total in payment section
    updatePaymentTotal(grandTotal);
  }

  // Form validation before submission (phone is optional)
  document
    .querySelector(".pharmacy-form")
    .addEventListener("submit", function (e) {
      // Check if medicines are added
      const medicinesRows = document.querySelectorAll("#medicines_tbody tr");
      if (medicinesRows.length === 0) {
        e.preventDefault();
        alert("âš  Please add at least one medicine to the prescription.");
        return false;
      }

      // If phone provided for a new patient, ensure it is valid digits-only 10 length
      const uhid = document.getElementById("uhid").value.trim();
      const phoneNo = document.getElementById("phone_no").value.trim();
      if (
        !uhid &&
        phoneNo &&
        (phoneNo.length !== 10 || !/^\d{10}$/.test(phoneNo))
      ) {
        e.preventDefault();
        alert(
          "âš  Please enter a valid 10-digit phone number or leave it blank."
        );
        document.getElementById("phone_no").focus();
        return false;
      }

      // Payment validation
      const mode = (document.getElementById("payment_mode").value || "").trim();
      const cashVal = parseFloat(
        document.getElementById("cash_amount").value || "0"
      );
      const upiVal = parseFloat(
        document.getElementById("upi_amount").value || "0"
      );
      const discountVal = parseFloat(
        document.getElementById("discount_amount").value || "0"
      );
      // Negative discount adds to total, positive discount subtracts
      const payable = Math.max(
        grandTotal - (isNaN(discountVal) ? 0 : discountVal),
        0
      );

      if (!mode) {
        e.preventDefault();
        alert("âš  Please select a payment mode.");
        return false;
      }

      if (mode === "Cash") {
        // Auto set full amount to cash when empty
        if (!cashVal) {
          document.getElementById("cash_amount").value = payable.toFixed(2);
        }
        document.getElementById("upi_amount").value = "0.00";
      } else if (mode === "UPI") {
        if (!upiVal) {
          document.getElementById("upi_amount").value = payable.toFixed(2);
        }
        document.getElementById("cash_amount").value = "0.00";
      } else if (mode === "Both") {
        const sum = (cashVal || 0) + (upiVal || 0);
        if (Math.abs(sum - payable) > 0.01) {
          e.preventDefault();
          alert(
            `âš  Cash + UPI (â‚¹${sum.toFixed(
              2
            )}) must equal total â‚¹${payable.toFixed(2)}.`
          );
          return false;
        }
      }

      return true;
    });

  // Payment mode UI logic
  function updatePaymentTotal(total) {
    const payTotal = document.getElementById("pay_total_readonly");
    if (!payTotal) return;
    
    // Always try to get the current total from the displayed grand total element
    // This ensures we're using the actual current total, not a stale variable
    let baseTotal = Number(total || 0);
    const grandTotalElement = document.getElementById("grand_total");
    if (grandTotalElement) {
      const grandTotalText = grandTotalElement.textContent || grandTotalElement.innerText || "";
      // Extract number from text like "â‚¹733.00" or "â‚¹733"
      const match = grandTotalText.match(/â‚¹?\s*([\d,]+\.?\d*)/);
      if (match) {
        const extractedTotal = parseFloat(match[1].replace(/,/g, "")) || 0;
        if (extractedTotal > 0) {
          baseTotal = extractedTotal;
        }
      }
    }
    
    const discount = getDiscountValue();
    // If discount is negative, it adds to total (e.g., -21 adds â‚¹21)
    // If discount is positive, it subtracts from total (e.g., 21 subtracts â‚¹21)
    // Formula: total - discount, so -21 becomes: total - (-21) = total + 21
    const discountValue = Number(discount || 0);
    // Calculate: baseTotal - discountValue
    // Example: 733 - (-21) = 733 + 21 = 754
    const payable = Math.max(baseTotal - discountValue, 0);
    payTotal.value = `â‚¹${payable.toFixed(2)}`;
  }

  function handlePaymentModeChange() {
    const mode = (document.getElementById("payment_mode").value || "").trim();
    const cashField = document.getElementById("cash_amount_field");
    const upiField = document.getElementById("upi_amount_field");
    const cashInput = document.getElementById("cash_amount");
    const upiInput = document.getElementById("upi_amount");

    if (mode === "Cash") {
      // For Cash only, hide both input fields (only show Total to Pay)
      cashField.style.display = "none";
      upiField.style.display = "none";
      cashInput.value = "";
      upiInput.value = "";
    } else if (mode === "UPI") {
      // For UPI only, hide both input fields (only show Total to Pay)
      cashField.style.display = "none";
      upiField.style.display = "none";
      cashInput.value = "";
      upiInput.value = "";
    } else if (mode === "Both") {
      cashField.style.display = "block";
      upiField.style.display = "block";
      cashInput.placeholder = "Cash part";
      upiInput.placeholder = "UPI part";
    } else {
      cashField.style.display = "none";
      upiField.style.display = "none";
      cashInput.value = "";
      upiInput.value = "";
    }
  }

  document
    .getElementById("payment_mode")
    .addEventListener("change", handlePaymentModeChange);

  // Recalculate payable when discount changes
  const discountInput = document.getElementById("discount_amount");
  if (discountInput) {
    const recalculateDiscount = function() {
      // Always use current grandTotal variable, or let updatePaymentTotal get it from DOM
      updatePaymentTotal(grandTotal);
    };
    discountInput.addEventListener("input", recalculateDiscount);
    discountInput.addEventListener("change", recalculateDiscount);
    discountInput.addEventListener("blur", recalculateDiscount);
    // Also trigger on keyup for immediate feedback
    discountInput.addEventListener("keyup", recalculateDiscount);
  }

  // Initialize payment total on load
  updatePaymentTotal(grandTotal);
</script>

{% endblock %}
